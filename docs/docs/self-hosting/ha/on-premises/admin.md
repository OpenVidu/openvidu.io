# OpenVidu High Availability: On-premises configuration and administration

The OpenVidu installer offers an easy way to deploy OpenVidu High Availability on-premises. However, once the deployment is complete, you may need to perform administrative tasks based on your specific requirements, such as changing passwords, specifying custom configurations, and starting or stopping services.

This section provides details on configuration parameters and common administrative tasks for on-premises OpenVidu High Availability deployments.

## OpenVidu configuration

### Directory structure

OpenVidu High Availability is composed of two types of nodes, Master Nodes and Media Nodes. The directory structure is as follows for each type of node:

=== "Master Nodes"

    In each Master Node, the services are installed at `/opt/openvidu/` and have a systemd service located at `/etc/systemd/system/openvidu.service`.

    The directory structure of each Master Node is as follows:

    ```bash
    |-- /opt/openvidu
        |-- config/
        |-- data/
        |-- deployment-info.yaml
        |-- docker-compose.override.yml
        |-- docker-compose.yml
        |-- .env
        `-- owncert/
    ```

    - **`config/`**: Contains the configuration files for the services deployed in the Master Node.
    - **`data/`**: Contains the data generated by the services deployed with the Master Node.
    - **`deployment-info.yaml`**: Contains the deployment information of the Master Node.
    - **`docker-compose.override.yml`**: Contains the service with the Default App (OpenVidu Call) deployed with OpenVidu.
    - **`docker-compose.yml`**: Contains the main services deployed for the Master Node.
    - **`.env`**: Contains parameters managed by multiple services.
    - **`owncert/`**: Contains the custom certificates for the Caddy server if you are using your own certificates.

=== "Media Node"

    In each Media Node, the services are installed at `/opt/openvidu/` and have a systemd service located at `/etc/systemd/system/openvidu.service`.

    The directory structure of the Media Node is as follows:

    ```bash
    |-- /opt/openvidu
        |-- config/
        |-- data/
        |-- deployment-info.yaml
        |-- docker-compose.yml
        `-- .env
    ```

    - **`config/`**: Contains the configuration files for the services deployed with the Media Node.
    - **`data/`**: Contains the data generated by the services deployed with the Media Node.
    - **`deployment-info.yaml`**: Contains the deployment information of the Media Node.
    - **`docker-compose.yml`**: Contains the main services deployed for the Media Node.


### Services Configuration

Some services deployed with OpenVidu have their own configuration files located in the `/opt/openvidu/config/` directory, while others are configured in the `.env` file. Below are the services and their respective configuration files and parameters:

!!!info
    The installer provides default configurations that work out of the box. However, you can modify these configurations to suit your specific requirements.

#### Configuration Files

=== "Master Node"

    | Service             | Description | <div style="width:20em">Configuration File Location</div> | Reference documentation |
    | ------------------- | ----------- | --------------------------- | ------------------ |
    | **Caddy Server** | Serves OpenVidu services and handles HTTPS. | **`/opt/openvidu/config/caddy.yaml`** | [Caddy JSON Structure](https://caddyserver.com/docs/json/){:target=_blank} |
    | **Loki Service**        | Used for log aggregation. | **`/opt/openvidu/config/loki.yaml`** | [Loki Config](https://grafana.com/docs/loki/v2.8.x/configuration/){:target=_blank} |
    | **Promtail Service**    | Collects logs and sends them to Loki. | **`/opt/openvidu/config/promtail.yaml`** | [Promtail Config](https://grafana.com/docs/loki/v2.8.x/clients/promtail/configuration/){:target=_blank} |
    | **Mimir Service** | Service for long-term prometheus storage | **`/opt/openvidu/config/mimir.yaml`** | [Mimir Config](https://grafana.com/docs/mimir/v2.11.x/configure/about-configurations/){:target=_blank} |
    | **Grafana Service**     | Used for visualizing monitoring data. | **`/opt/openvidu/config/grafana_config/`** | [Grafana Config](https://grafana.com/docs/grafana/latest/administration/configuration/){:target=_blank} |

=== "Media Node"

    | Service             | Description | <div style="width:20em">Configuration File Location</div> | Reference documentation |
    | ------------------- | ----------- | --------------------------- | ------------------ |
    | **OpenVidu Server**     | Manages video rooms. It is compatible with LiveKit configuration and includes [its own OpenVidu configuration parameters](#openvidu-configuration-parameters) | **`/opt/openvidu/config/livekit.yaml`** | [LiveKit Config](https://github.com/OpenVidu/openvidu-livekit/blob/openvidu/main/config.yaml){:target=_blank} |
    | **Ingress Service**     | Imports video from other sources into OpenVidu rooms. | **`/opt/openvidu/config/ingress.yaml`** | [LiveKit Ingress Config](https://github.com/livekit/ingress/blob/v1.4.2/README.md#config){:target=_blank} |
    | **Egress Service**      | Exports video from OpenVidu rooms for recording or streaming. | **`/opt/openvidu/config/egress.yaml`** | [LiveKit Egress Config](https://github.com/livekit/egress/blob/v1.8.4/README.md#config){:target=_blank} |
    | **Prometheus Service**  | Used for monitoring. | **`/opt/openvidu/config/prometheus.yaml`** | [Prometheus Config](https://prometheus.io/docs/prometheus/2.50/getting_started/){:target=_blank} |
    | **Promtail Service**    | Collects logs and sends them to Loki. | **`/opt/openvidu/config/promtail.yaml`** | [Promtail Config](https://grafana.com/docs/loki/v2.8.x/clients/promtail/configuration/){:target=_blank} |
    | **Caddy Service**       | Allows Media Nodes to reach Master Node services in a balanced and high-available way. | **`/opt/openvidu/config/caddy.yaml`** | [Caddy JSON Structure](https://caddyserver.com/docs/json/){:target=_blank} |

#### Environment variables

=== "Master Node"

    !!!warning
        - All services use internally the values of `MASTER_NODE_X_PRIVATE_IP` where `X` is the Master Node number (1, 2, 3, and 4) defined in the `.env` file. These values are the private IP addresses of the Master Nodes. Ensure that these values are static IP addresses and are the same in all the Master Nodes and Media Nodes.

    | Service | Description | Environment Variables |
    | ------- | ----------- | --------------------- |
    | **Grafana Service** | Used for visualizing monitoring data. | <ul><li> **`GRAFANA_ADMIN_USERNAME`**: The username to access the Grafana dashboard.</li><li>**`GRAFANA_ADMIN_PASSWORD`**: The password to access the Grafana dashboard.</li></ul> |
    | **OpenVidu Dashboard** | Used to visualize OpenVidu Server Rooms, Ingress, and Egress services. | <ul><li>**`DASHBOARD_ADMIN_USERNAME`**: The username to access the OpenVidu Dashboard.</li><li>**`DASHBOARD_ADMIN_PASSWORD`**: The password to access the OpenVidu Dashboard.</li></ul> |
    | **Default App** (OpenVidu Call) | Default ready-to-use video conferencing app. | <ul><li>**`CALL_PRIVATE_ACCESS`**: If set to `true`, the app will be private and require authentication. If set to `false`, the app will be public and accessible without authentication. The user is configured with `CALL_USER` and `CALL_SECRET` parameters.</li><li>**`CALL_USER`**: The username to access the app. This parameter is only used if `CALL_PRIVATE_ACCESS` is set to `true`.</li><li>**`CALL_SECRET`**: The password to access the app. This parameter is only used if `CALL_PRIVATE_ACCESS` is set to `true`.</li><li>**`CALL_ADMIN_USERNAME`**: The username to access the OpenVidu Call Admin Panel.</li><li>**`CALL_ADMIN_SECRET`**: The password to access the OpenVidu Call Admin Panel.</li><li>**`LIVEKIT_API_KEY`**: The API key to access the LiveKit service.</li><li>**`LIVEKIT_API_SECRET`**: The API secret to access the LiveKit service.</li></ul> |
    | **Redis Service** | Used as a shared memory database for OpenVidu and Ingress/Egress services. | <ul><li>**`REDIS_PASSWORD`**: The password for the Redis service.</li></ul><br> If you need to change the Redis password after the installation, [check the advanced configuration section](#changing-redis_password). |
    | **MinIO Service** | Used for storing recordings. | <ul><li>**`MINIO_ACCESS_KEY`**: The access key for the MinIO service.</li><li>**`MINIO_SECRET_KEY`**: The secret key for the MinIO service.</li></ul><br> If you need to change the MinIO access key and secret key after the installation, [check the advanced configuration section](#changing-minio_access_key-and-minio_secret_key). |
    | **MongoDB Service** | Used for storing analytics and monitoring data. | <ul><li>**`MONGO_ADMIN_USERNAME`**: The username to access the MongoDB database.</li><li>**`MONGO_ADMIN_PASSWORD`**: The password to access the MongoDB database.</li><li>**`MONGO_REPLICA_SET_KEY`**: The replica set key for the MongoDB database.</li></ul><br> If you need to change the MongoDB username and password after the installation, [check the advanced configuration section](#changing-mongo_admin_username-and-mongo_admin_password). |
    | **OpenVidu v2 compatibility Service** | Used to enable compatibility with OpenVidu v2. | Check the [OpenVidu v2 Compatibility Configuration Parameters](#openvidu-v2-compatibility-configuration-parameters) to see all the available parameters. |

=== "Media Node"

    !!!warning
        - All services use internally the values of `MASTER_NODE_X_PRIVATE_IP` where `X` is the Master Node number (1, 2, 3, and 4) defined in the `.env` file. These values are the private IP addresses of the Master Nodes. Ensure that these values are static IP addresses and are the same in all the Master Nodes and Media Nodes.
        - All services use internally the `MEDIA_NODE_PRIVATE_IP` value defined in the `.env` file. This value is the private IP address of the Media Node. Ensure that this value is a static IP address. It should be different from Media Node to Media Node.

    | Service               | Description                                            | Environment Variables                                                                                                                 |
    |-----------------------|--------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------|
    | **OpenVidu Server**   | Manages video rooms.                                   | <ul><li>**`MASTER_NODE_X_PRIVATE_IP`**: The private IP addresses of all Master Nodes. Used to connect to Master Node services.</li><li>**`MEDIA_NODE_PRIVATE_IP`**: The private IP address of the Media Node. On startup, the OpenVidu Server registers itself with this IP address so that the Caddy server from Master Nodes can route requests to the Media Node.</li></ul> |
    | **Ingress Service**   | Imports video from other sources into OpenVidu rooms.  | <ul><li>**`MASTER_NODE_X_PRIVATE_IP`**: The private IP addresses of all Master Nodes. Used to connect to the Master Node services.</li></ul> |
    | **Egress Service**    | Exports video from OpenVidu rooms for recording or streaming. | <ul><li>**`MASTER_NODE_X_PRIVATE_IP`**: The private IP addresses of all Master Nodes. Used to connect to the Master Node services.</li></ul> |
    | **Prometheus Service**| Used for monitoring.                                   | <ul><li>**`MASTER_NODE_X_PRIVATE_IP`**: The private IP addresses of all Master Nodes. Used to connect to the Master Node services.</li></ul> |
    | **Promtail Service**  | Collects logs and sends them to Loki.                 | <ul><li>**`MASTER_NODE_X_PRIVATE_IP`**: The private IP addresses of all Master Nodes. Used to connect to the Master Node services.</li></ul> |

--8<-- "docs/docs/self-hosting/shared/openvidu-pro-configuration-parameters.md"

#### OpenVidu v2 Compatibility Configuration Parameters

--8<-- "docs/docs/self-hosting/shared/openvidu-pro-v2-compatibility-common.md"

--8<-- "docs/docs/self-hosting/shared/openvidu-pro-start-stop-restart.md"

## Checking the status of services

You can check the status of the OpenVidu services using the following command:

```bash
cd /opt/openvidu/
docker compose ps
```

Depending on the node type, you will see different services running.

=== "Master Node"

    The services are operating correctly if you see an output similar to the following and there are no restarts from any of the services:

    ```bash
    NAME                       IMAGE                                              COMMAND                  SERVICE                    CREATED          STATUS
    app                        docker.io/openvidu/openvidu-call                   "docker-entrypoint.s…"   app                        12 seconds ago   Up 10 seconds
    caddy                      docker.io/openvidu/openvidu-pro-caddy              "/bin/caddy run --co…"   caddy                      12 seconds ago   Up 10 seconds
    dashboard                  docker.io/openvidu/openvidu-pro-dashboard          "./openvidu-dashboard"   dashboard                  12 seconds ago   Up 10 seconds
    grafana                    docker.io/grafana/grafana                          "/run.sh"                grafana                    11 seconds ago   Up 8 seconds
    loki                       docker.io/grafana/loki                             "/usr/bin/loki -conf…"   loki                       11 seconds ago   Up 9 seconds
    mimir                      docker.io/grafana/mimir                            "/bin/mimir -config.…"   mimir                      11 seconds ago   Up 9 seconds
    minio                      docker.io/bitnami/minio                            "/opt/bitnami/script…"   minio                      11 seconds ago   Up 9 seconds
    mongo                      docker.io/mongo                                    "docker-entrypoint.s…"   mongo                      11 seconds ago   Up 9 seconds
    openvidu-v2compatibility   docker.io/openvidu/openvidu-v2compatibility        "/bin/server"            openvidu-v2compatibility   12 seconds ago   Up 10 seconds
    operator                   docker.io/openvidu/openvidu-operator               "/bin/operator"          operator                   12 seconds ago   Up 10 seconds
    promtail                   docker.io/grafana/promtail                         "/usr/bin/promtail -…"   promtail                   11 seconds ago   Up 9 seconds
    redis-sentinel             docker.io/redis                                    "docker-entrypoint.s…"   redis-sentinel             10 seconds ago   Up 10 seconds
    redis-server               docker.io/redis                                    "docker-entrypoint.s…"   redis-server               10 seconds ago   Up 10 seconds
    ```

=== "Media Node"

    The services are operating correctly if you see an output similar to the following and there are no restarts from any of the services:

    ```bash
    NAME         IMAGE                                          COMMAND                  SERVICE      CREATED          STATUS
    caddy        docker.io/openvidu/openvidu-caddy:main         "/bin/caddy run --co…"   caddy        53 seconds ago   Up 53 seconds
    egress       docker.io/livekit/egress                       "/entrypoint.sh"         egress       53 seconds ago   Up 51 seconds
    ingress      docker.io/livekit/ingress                      "ingress"                ingress      53 seconds ago   Up 52 seconds
    openvidu     docker.io/openvidu/openvidu-server-pro         "/livekit-server --c…"   openvidu     53 seconds ago   Up 52 seconds
    prometheus   docker.io/prom/prometheus                      "/bin/prometheus --c…"   prometheus   53 seconds ago   Up 51 seconds
    promtail     docker.io/grafana/promtail                     "/usr/bin/promtail -…"   promtail     53 seconds ago   Up 52 seconds
    ```

--8<-- "docs/docs/self-hosting/shared/openvidu-pro-checking-logs.md"

## Adding and Removing Media Nodes

Adding and removing Media Nodes is straightforward. You can add new Media Nodes to the cluster to increase the capacity of your OpenVidu deployment. Similarly, you can remove Media Nodes to reduce the capacity of your deployment.

### Adding Media Nodes

To add a new Media Node, simply spin up a new VM and run the OpenVidu installer script to integrate it into the existing cluster. Run the [installation command](../on-premises/install-nlb.md/#media-node) on the new Media Node.

!!!warning
    This installation command should be the same as the one you used to install the first Media Node. Make sure to use the same parameters and values as the first Media Node.
    In case you've changed the `.env` file in the Master Nodes, you will need to update the `.env` file or update the installation command with the new values.

To automate the configuration of new nodes, check [this section](#automatic-installation-and-configuration-of-nodes).

--8<-- "docs/docs/self-hosting/shared/openvidu-pro-removing-media-nodes.md"

## Advanced Configuration

This section addresses advanced configuration scenarios for customizing your OpenVidu High Availability deployment. It includes automating the installation with personalized settings, enabling or disabling OpenVidu modules, and modifying global parameters such as the domain name, passwords, and API keys.

### Automatic installation and configuration of nodes

For environments like the cloud, where instances are frequently spun up and down, automating the application of custom configurations to Master Nodes and Media Nodes may be useful for you.

=== "Master Node"

    If you need to apply custom configurations to your Master Nodes, you can use the following script template:


    ```bash
    # 1. First install the Master Node (1)
    sh <(curl -fsSL http://get.openvidu.io/pro/ha/latest/install_ov_master_node.sh) \
        --node-role='master-node' \
        ... # Add the rest of the arguments (2)

    # 2. Add custom configurations (3)
    ######### APPLY CUSTOM CONFIGURATIONS #########
    # If you want to apply any modification to the configuration files
    # of the OpenVidu services at /opt/openvidu, you can do it here.

    # Example 1: Change Minio public port
    yq eval '.apps.http.servers.minio.listen[0] = ":9001"' -i /opt/openvidu/config/caddy.yaml

    # Example 2: Disable the /dashboard route in Caddy
    yq eval 'del(.apps.http.servers.public.routes[] | \
      select(.handle[]?.handler == "subroute" and \
      .handle[].routes[].handle[].strip_path_prefix == "/dashboard"))' \
      -i /opt/openvidu/config/caddy.yaml

    ######### END CUSTOM CONFIGURATIONS #########

    # 3. Start OpenVidu (4)
    systemctl start openvidu
    ```

    1. First, install the Master Node using the OpenVidu installer. Check the [installation guide](install-dlb.md) for more information.
    2. Add the parameters you need to install the Master Node. You can find all the available parameters in the [installation guide](install-dlb.md).
    3. Add the custom configurations you need to apply to the Master Node services. You can use `yq` or other tools to modify the configuration files. You can find more information about `yq` [here](https://mikefarah.gitbook.io/yq/){:target=_blank}.
    4. Start the Master Node.

    --8<-- "docs/docs/self-hosting/shared/install-version.md"

    Just install the Master Node first with the installer and then run some extra commands to apply the custom configurations. This way, you can automate the process of installing the Master Node and applying custom configurations.

=== "Media Node"

    If you need to apply custom configurations to the Media Node, you can use the following script template:

    ```bash
    # 1. First install the Media Node (1)
    sh <(curl -fsSL http://get.openvidu.io/pro/ha/latest/install_ov_media_node.sh) \
        --node-role='media-node' \
        ... # Add the rest of the arguments (2)

    # 2. Add custom configurations (3)
    ######### APPLY CUSTOM CONFIGURATIONS #########
    # If you want to apply any modification to the configuration files
    # of the OpenVidu services at /opt/openvidu, you can do it in this section.

    # Example 1: Change public IP address announced by OpenVidu for WebRTC connections
    yq eval '.rtc.node_ip = 1.2.3.4' \
        -i /opt/openvidu/config/livekit.yaml

    # Example 2: Add a webhook to LiveKit
    yq eval '.webhook.urls += ["http://new-endpoint.example.com/webhook"]' \
        -i /opt/openvidu/config/livekit.yaml

    ######### END CUSTOM CONFIGURATIONS #########

    # 3. Start OpenVidu (4)
    systemctl start openvidu
    ```

    1. First, install the Media Node using the OpenVidu installer. Check the [installation guide](install-dlb.md#media-node) for more information.
    2. Add the parameters you need to install the Media Node. You can find all the available parameters in the [installation guide](install-dlb.md#media-node).
    3. Add the custom configurations you need to apply to the Media Node services. You can use `yq` or other tools to modify the configuration files. You can find more information about `yq` [here](https://mikefarah.gitbook.io/yq/){:target=_blank}.
    4. Start the Media Node.

    --8<-- "docs/docs/self-hosting/shared/install-version.md"

    Just install the Media Node first with the installer and then run some extra commands to apply the custom configurations. This way, you can automate the process of installing the Media Node and applying custom configurations.

### Enabling and Disabling OpenVidu Modules

The `COMPOSE_PROFILES` parameter in the `.env` file in Master and Media Nodes allows you to enable or disable specific modules in OpenVidu. The following modules can be enabled or disabled:

=== "_Observability_ module"

    In case you have installed OpenVidu with the `observability` module, you just need to enable the `observability` module in the `.env` file in all nodes.

    Otherwise, you can follow these steps to enable the `observability` module:

    1. **Stop all Master Nodes and all Media Nodes, and backup the deployment**

        ```bash
        sudo systemctl stop openvidu
        sudo cp -r /opt/openvidu/ /opt/openvidu_backup/
        ```

    2. **In the Master Nodes, update the `.env` with the following changes:**

        Add to the `COMPOSE_PROFILES` the `observability` module. Also, make sure to set up the `GRAFANA_ADMIN_USERNAME` and `GRAFANA_ADMIN_PASSWORD` parameters.

        If you have only the observability module enabled, your `.env` file should have the following environment variables:

        ```bash
        GRAFANA_ADMIN_USERNAME="<GRAFANA_ADMIN_USERNAME>"
        GRAFANA_ADMIN_PASSWORD="<GRAFANA_ADMIN_PASSWORD>"

        COMPOSE_PROFILES="observability"
        ```

    3. **In the Media Nodes, enable the `observability` module:**

        Add to the `COMPOSE_PROFILES` the `observability` module in the `.env` file. If you have only the `observability` module enabled, your `.env` file should have the following environment variable:

        ```bash
        COMPOSE_PROFILES="observability"
        ```

        Then, add the following parameter in the `config/livekit.yaml` file:

        ```yaml
        prometheus_port: 6789
        ```

    4. **Start all Master Nodes and Media Nodes**

        ```bash
        sudo systemctl start openvidu
        ```

    **Disabling the `observability` module**

    If you have the `observability` module enabled, and you want to disable it, just remove the `observability` module from the `COMPOSE_PROFILES` parameter in the `.env` file of all nodes.

=== "_V2 Compatibility_ module"

    In case you have installed OpenVidu with the `v2compatibility` module, you just need to enable the `v2compatibility` module in the `.env` file in all nodes.

    Otherwise, you can follow these steps to enable the `v2compatibility` module:

    1. **Stop all Master Nodes, all Media Nodes, and backup the deployment**

        ```bash
        sudo systemctl stop openvidu
        sudo cp -r /opt/openvidu/ /opt/openvidu_backup/
        ```

    2. **In the Master Nodes, update the `.env` with the following changes:**

        Add to the `COMPOSE_PROFILES` the `v2compatibility` module.

        If you have only the `v2compatibility` module enabled, your `.env` file should have the following environment variable:

        ```bash
        COMPOSE_PROFILES="v2compatibility"
        ```

    3. **In the Media Nodes, update the LiveKit configuration to send webhooks to the V2 Compatibility service**

        Just add the following parameter in the `config/livekit.yaml` file:

        ```yaml
        webhook:
            api_key: "<LIVEKIT_API_KEY>"
            urls:
                - http://localhost:4443/livekit/webhook
        ```

        Where `<LIVEKIT_API_KEY>` is the `LIVEKIT_API_KEY` parameter in the `.env` file.

        Note that the URL is `http://localhost:4443` because an internal caddy proxy will balance the requests to all the V2 Compatibility services running in the Master Nodes.

    4. **Start all Master Nodes and Media Nodes**

        ```bash
        sudo systemctl start openvidu
        ```

    **Disabling the `v2compatibility` module**

    If you have the `v2compatibility` module enabled, and you want to disable it, just remove the `v2compatibility` module from the `COMPOSE_PROFILES` parameter in the `.env` file of all nodes.

=== "_App_ module (Default App)"

    In case you have installed OpenVidu without the `app` module, you just need to enable the `app` module in the `.env` file in all nodes.

    Otherwise, you can follow these steps to enable the `app` module:

    1. **Stop all Master Nodes, all Media Nodes, and backup the deployment**

        ```bash
        sudo systemctl stop openvidu
        sudo cp -r /opt/openvidu/ /opt/openvidu_backup/
        ```

    2. **In all Master Nodes, update the `.env` with the following changes:**

        Add to the `COMPOSE_PROFILES` the `app` module.

        If you have only the `app` module enabled, your `.env` file should have the following environment variable:

        ```bash
        COMPOSE_PROFILES="app"
        ```

    3. **In the Media Nodes, update the LiveKit configuration to send webhooks to the Default App**

        Just add the following parameter in the `config/livekit.yaml` file:

        ```yaml
        webhook:
            api_key: "<LIVEKIT_API_KEY>"
            urls:
                - http://localhost:6080/api/webhook
        ```

        Where `<LIVEKIT_API_KEY>` is the `LIVEKIT_API_KEY` parameter in the `.env` file.

        Note that the URL is `http://localhost:6080` because an internal caddy proxy will balance the requests to all the Default App services running in the Master Nodes.

    4. **Start all Master Nodes and Media Nodes**

        ```bash
        sudo systemctl start openvidu
        ```

    **Disabling the `app` module**

    If you have the `app` module enabled, and you want to disable it, just remove the `app` module from the `COMPOSE_PROFILES` parameter in the `.env` file of all nodes.

### Global configuration changes

Some configuration parameters may require modifying multiple configuration files. Below are some examples of advanced configurations and how to apply them:

!!!info
    Usually, this is not needed because the installer takes care of generating all of this parameters. However, it is necessary if any password, credential, or domain change is needed.

!!!danger
    Advanced configurations should be performed with caution. Incorrect configurations can lead to service failures or unexpected behavior.

    Before making any changes, make sure to back up your installation by creating a snapshot of your server or by copying the `/opt/openvidu/` directory to a safe location. For example:

    ```bash
    sudo cp -r /opt/openvidu/ /opt/openvidu_backup/
    ```

=== "Changing `DOMAIN_OR_PUBLIC_IP`"

    To change all occurrences of the domain or public IP address in the configuration files, follow these steps:

    1. **Stop OpenVidu in all Master Nodes and all Media Nodes and backup the deployment**

        ```bash
        sudo systemctl stop openvidu
        sudo cp -r /opt/openvidu/ /opt/openvidu_backup/
        ```

    2. **Find the current locations of `DOMAIN_OR_PUBLIC_IP` in your Master Nodes**

        With the following commands, you can find all occurrences of the current domain or public IP address in the configuration files:

        ```bash
        sudo su
        cd /opt/openvidu/
        CURRENT_DOMAIN_OR_PUBLIC_IP="$(grep '^DOMAIN_OR_PUBLIC_IP' /opt/openvidu/.env | cut -d '=' -f 2)"
        grep --exclude-dir=data -IHnr "$CURRENT_DOMAIN_OR_PUBLIC_IP" .
        ```

        !!!warning
            Keep the value of `CURRENT_DOMAIN_OR_PUBLIC_IP` as you will need it to update the configuration files in the Media Nodes.

        === "Example output"

            The output should look similar to the following:

            ```bash
            ./.env:DOMAIN_OR_PUBLIC_IP=<CURRENT_DOMAIN_OR_PUBLIC_IP>
            ./config/caddy.yaml:        - certificate: /owncert/<CURRENT_DOMAIN_OR_PUBLIC_IP>.cert
            ./config/caddy.yaml:          key: /owncert/<CURRENT_DOMAIN_OR_PUBLIC_IP>.key
            ./config/caddy.yaml:            - <CURRENT_DOMAIN_OR_PUBLIC_IP>
            ./config/caddy.yaml:                    - <CURRENT_DOMAIN_OR_PUBLIC_IP>
            ./config/caddy.yaml:                        - <CURRENT_DOMAIN_OR_PUBLIC_IP>
            ./config/caddy.yaml:                    - <CURRENT_DOMAIN_OR_PUBLIC_IP>
            ./config/caddy.yaml:                        - <CURRENT_DOMAIN_OR_PUBLIC_IP>
            ./config/caddy.yaml:                  - <CURRENT_DOMAIN_OR_PUBLIC_IP>
            ./config/promtail.yaml:          cluster_id: <CURRENT_DOMAIN_OR_PUBLIC_IP>
            ```

            !!!note
                Don't worry if some values are different in your output. It varies depending on the parameters you've used to install OpenVidu.

    3. **Update the Following Files in all your Master Nodes**

        Based on the output from the previous step, update the following files with the new domain or public IP address:

        - `.env`
        - `config/caddy.yaml`
        - `config/promtail.yaml`

    4. **Verify the changes in all your Master Nodes**

        These commands will list all occurrences of the new `DOMAIN_OR_PUBLIC_IP` in the configuration files. The output should match the locations found in the initial search but with the new domain or public IP address.

        ```bash
        sudo su
        cd /opt/openvidu/
        NEW_DOMAIN_OR_PUBLIC_IP="<NEW_DOMAIN_OR_PUBLIC_IP>"
        grep --exclude-dir=data -IHnr "$NEW_DOMAIN_OR_PUBLIC_IP" .
        ```

    5. **Ensure to follow from step 2 to 4 for all your Master Nodes**

    6. **Find the current locations of `CURRENT_DOMAIN_OR_PUBLIC_IP` in your Media Nodes**

        With the `CURRENT_DOMAIN_OR_PUBLIC_IP` value obtained in step 2, you can find all occurrences of the current domain or public IP address in the configuration files of the Media Nodes. To do this, connect to each Media Node and run the following command:

        ```bash
        sudo su
        cd /opt/openvidu/
        CURRENT_DOMAIN_OR_PUBLIC_IP="<CURRENT_DOMAIN_OR_PUBLIC_IP>"
        grep --exclude-dir=data -IHnr "$CURRENT_DOMAIN_OR_PUBLIC_IP" .
        ```

        === "Example output"

            The output should look similar to the following:

            ```bash
            ./config/promtail.yaml:          cluster_id: <CURRENT_DOMAIN_OR_PUBLIC_IP>
            ./config/livekit.yaml:    cluster_id: <CURRENT_DOMAIN_OR_PUBLIC_IP>
            ./config/livekit.yaml:    rtmp_base_url: rtmps://<CURRENT_DOMAIN_OR_PUBLIC_IP>:1935/rtmp
            ./config/livekit.yaml:    whip_base_url: https://<CURRENT_DOMAIN_OR_PUBLIC_IP>/whip
            ```

    7. **Update the Following Files in your Media Nodes**

        Based on the output from the previous step, update the following files with the new domain or public IP address:

        - `config/promtail.yaml`
        - `config/livekit.yaml`

    8. **Verify the changes in your Media Nodes**

        These commands will list all occurrences of the new `DOMAIN_OR_PUBLIC_IP` in the configuration files of the Media Nodes. The output should match the locations found in the initial search but with the new domain or public IP address.

        ```bash
        sudo su
        cd /opt/openvidu/
        NEW_DOMAIN_OR_PUBLIC_IP="<NEW_DOMAIN_OR_PUBLIC_IP>"
        grep --exclude-dir=data -IHnr "$NEW_DOMAIN_OR_PUBLIC_IP" .
        ```

    9. **Ensure to follow from step 5 to 7 for all your Media Nodes**

    10. **Start all Master Nodes and Media Nodes**

        ```bash
        sudo systemctl start openvidu
        ```

    Some notes on changing the `DOMAIN_OR_PUBLIC_IP` parameter:

    - If you are using your own certificates, you need to place the new ones at `/opt/openvidu/owncert/<NEW_DOMAIN_OR_PUBLIC_IP>.cert` and `/opt/openvidu/owncert/<NEW_DOMAIN_OR_PUBLIC_IP>.key`.
    - Make sure your new domain is pointing correctly to the machine where OpenVidu is installed.

=== "Changing `REDIS_PASSWORD`"

    To change the `REDIS_PASSWORD` parameter, follow these steps:

    1. **Stop OpenVidu in all the Master Nodes and all Media Nodes and backup the deployment**

        ```bash
        sudo systemctl stop openvidu
        sudo cp -r /opt/openvidu/ /opt/openvidu_backup/
        ```

    2. **Replace in all Master Nodes the `REDIS_PASSWORD` in the `.env` file with your new value**

        !!!warning
            Keep the previous value of `REDIS_PASSWORD` as you will need it to update the configuration files in the Media Nodes. We will refer to this value as `<CURRENT_REDIS_PASSWORD>`.

    3. **Ensure to replace the `REDIS_PASSWORD` in the `.env` file of all your Master Nodes**

    4. **Find the current locations of `REDIS_PASSWORD` in your Media Nodes**

        With the `CURRENT_REDIS_PASSWORD` value obtained in step 2, you can find all occurrences of the current Redis password in the configuration files of the Media Nodes. To do this, connect to each Media Node and run the following command:

        ```bash
        sudo su
        cd /opt/openvidu/
        CURRENT_REDIS_PASSWORD="<CURRENT_REDIS_PASSWORD>"
        grep --exclude-dir=data -IHnr "$CURRENT_REDIS_PASSWORD" .
        ```

        === "Example output"

            The output should look similar to the following:

            ```bash
            ./config/egress.yaml:    password: <CURRENT_REDIS_PASSWORD>
            ./config/ingress.yaml:    password: <CURRENT_REDIS_PASSWORD>
            ./config/livekit.yaml:    password: <CURRENT_REDIS_PASSWORD>
            ```

    5. **Update the Following Files in your Media Nodes**

        Based on the output from the previous step, update the following files with the new Redis password:

        - `config/egress.yaml`
        - `config/ingress.yaml`
        - `config/livekit.yaml`

    6. **Verify the changes in your Media Nodes**

        These commands will list all occurrences of the new `REDIS_PASSWORD` in the configuration files of the Media Nodes. The output should match the locations found in the initial search but with the new Redis password.

        ```bash
        sudo su
        cd /opt/openvidu/
        NEW_REDIS_PASSWORD="<NEW_REDIS_PASSWORD>"
        grep --exclude-dir=data -IHnr "$NEW_REDIS_PASSWORD" .
        ```

    7. **Ensure to follow from step 3 to 5 for all your Media Nodes**

    8. **Start all Master Nodes and Media Nodes**

        ```bash
        sudo systemctl start openvidu
        ```

=== "Changing `LIVEKIT_API_KEY` and `LIVEKIT_API_SECRET`"

    To change the `LIVEKIT_API_KEY` and `LIVEKIT_API_SECRET` parameters, follow these steps:

    1. **Stop OpenVidu in all Master Nodes and all Media Nodes and backup the deployment**

        ```bash
        sudo systemctl stop openvidu
        sudo cp -r /opt/openvidu/ /opt/openvidu_backup/
        ```

    2. **Replace at the Master Nodes the `LIVEKIT_API_KEY` and `LIVEKIT_API_SECRET` in the `.env` file with your new values**

        !!!warning
            Keep the previous values of `LIVEKIT_API_KEY` and `LIVEKIT_API_SECRET` as you will need them to update the configuration files in the Media Nodes. We will refer to these values as `<CURRENT_LIVEKIT_API_KEY>` and `<CURRENT_LIVEKIT_API_SECRET>`.

    3. **Ensure to replace the `LIVEKIT_API_KEY` and `LIVEKIT_API_SECRET` in the `.env` file of all your Master Nodes**

    4. **Find the current locations of `LIVEKIT_API_KEY` and `LIVEKIT_API_SECRET` in your Media Nodes**

        With the `CURRENT_LIVEKIT_API_KEY` and `CURRENT_LIVEKIT_API_SECRET` values obtained in step 2, you can find all occurrences of the current LiveKit API key and secret in the configuration files of the Media Nodes. To do this, connect to each Media Node and run the following command:

        ```bash
        sudo su
        cd /opt/openvidu/
        CURRENT_LIVEKIT_API_KEY="<CURRENT_LIVEKIT_API_KEY>"
        CURRENT_LIVEKIT_API_SECRET="<CURRENT_LIVEKIT_API_SECRET>"
        grep --exclude-dir=data -IHnr "$CURRENT_LIVEKIT_API_KEY" .
        grep --exclude-dir=data -IHnr "$CURRENT_LIVEKIT_API_SECRET" .
        ```

        === "Example output"

            The output should look similar to the following for `LIVEKIT_API_KEY`:

            ```bash
            ./config/egress.yaml:api_key: <CURRENT_LIVEKIT_API_KEY>
            ./config/ingress.yaml:api_key: <CURRENT_LIVEKIT_API_KEY>
            ./config/livekit.yaml:    <CURRENT_LIVEKIT_API_KEY>: <CURRENT_LIVEKIT_API_SECRET>
            ./config/livekit.yaml:    api_key: <CURRENT_LIVEKIT_API_KEY>
            ```

            And for `LIVEKIT_API_SECRET`:

            ```bash
            ./config/egress.yaml:api_secret: <CURRENT_LIVEKIT_API_SECRET>
            ./config/ingress.yaml:api_secret: <CURRENT_LIVEKIT_API_SECRET>
            ./config/livekit.yaml:    <CURRENT_LIVEKIT_API_KEY>: <CURRENT_LIVEKIT_API_SECRET>
            ```

    5. **Update the Following Files in your Media Nodes**

        Based on the output from the previous step, update the following files with the new values:

        - `config/egress.yaml`
        - `config/ingress.yaml`
        - `config/livekit.yaml`

    6. **Verify the changes in your Media Nodes**

        These commands will list all occurrences of the new `LIVEKIT_API_KEY` and `LIVEKIT_API_SECRET` in the configuration files of the Media Nodes. The output should match the locations found in the initial search but with the new values.

        ```bash
        sudo su
        cd /opt/openvidu/
        NEW_LIVEKIT_API_KEY="<NEW_LIVEKIT_API_KEY>"
        NEW_LIVEKIT_API_SECRET="<NEW_LIVEKIT_API_SECRET>"
        grep --exclude-dir=data -IHnr "$NEW_LIVEKIT_API_KEY" .
        grep --exclude-dir=data -IHnr "$NEW_LIVEKIT_API_SECRET" .
        ```

    7. **Ensure to follow from step 3 to 5 for all your Media Nodes**

    8. **Start all Master Nodes and Media Nodes**

        ```bash
        sudo systemctl start openvidu
        ```

=== "Changing `MINIO_ACCESS_KEY` and `MINIO_SECRET_KEY`"

    To change the `MINIO_ACCESS_KEY` and `MINIO_SECRET_KEY` parameters, follow these steps:

    1. **Stop OpenVidu in all the Master Nodes and all Media Nodes and backup the deployment**

        ```bash
        sudo systemctl stop openvidu
        sudo cp -r /opt/openvidu/ /opt/openvidu_backup/
        ```

    2. **Replace in all the Master Nodes the `MINIO_ACCESS_KEY` and `MINIO_SECRET_KEY` in the `.env` file with your new values**

        Take into account that if you are using the `v2compatibility` module in `COMPOSE_PROFILES`, you will need to change the `V2COMPAT_OPENVIDU_PRO_AWS_ACCESS_KEY` and `V2COMPAT_OPENVIDU_PRO_AWS_SECRET_KEY` parameters in the `.env` file.

        !!!warning
            Keep the previous values of `MINIO_ACCESS_KEY` and `MINIO_SECRET_KEY` as you will need them to update the configuration files in the Media Nodes. We will refer to these values as `<CURRENT_MINIO_ACCESS_KEY>` and `<CURRENT_MINIO_SECRET_KEY>`.

    3. **Ensure to apply the changes in the `.env` file of all your Master Nodes**

    4. **Find the current locations of `MINIO_ACCESS_KEY` and `MINIO_SECRET_KEY` in your Media Nodes**

        With the `CURRENT_MINIO_ACCESS_KEY` and `CURRENT_MINIO_SECRET_KEY` values obtained in step 2, you can find all occurrences of the current MinIO access key and secret in the configuration files of the Media Nodes. To do this, connect to each Media Node and run the following command:

        ```bash
        sudo su
        cd /opt/openvidu/
        CURRENT_MINIO_ACCESS_KEY="<CURRENT_MINIO_ACCESS_KEY>"
        CURRENT_MINIO_SECRET_KEY="<CURRENT_MINIO_SECRET_KEY>"
        grep --exclude-dir=data -IHnr "$CURRENT_MINIO_ACCESS_KEY" .
        grep --exclude-dir=data -IHnr "$CURRENT_MINIO_SECRET_KEY" .
        ```

        === "Example output"

            The output should look similar to the following for `MINIO_ACCESS_KEY`:

            ```bash
            ./config/egress.yaml:access_key: <CURRENT_MINIO_ACCESS_KEY>
            ```

            And for `MINIO_SECRET_KEY`:

            ```bash
            ./config/egress.yaml:secret: <CURRENT_MINIO_SECRET_KEY>
            ```

    5. **Update the Following Files in your Media Nodes**

        Based on the output from the previous step, update the following files with the new values:

        - `config/egress.yaml`

    6. **Verify the changes in your Media Nodes**

        These commands will list all occurrences of the new `MINIO_ACCESS_KEY` and `MINIO_SECRET_KEY` in the configuration files of the Media Nodes. The output should match the locations found in the initial search but with the new values.

        ```bash
        sudo su
        cd /opt/openvidu/
        NEW_MINIO_ACCESS_KEY="<NEW_MINIO_ACCESS_KEY>"
        NEW_MINIO_SECRET_KEY="<NEW_MINIO_SECRET_KEY>"
        grep --exclude-dir=data -IHnr "$NEW_MINIO_ACCESS_KEY" .
        grep --exclude-dir=data -IHnr "$NEW_MINIO_SECRET_KEY" .
        ```

    7. **Ensure to follow from step 3 to 5 for all your Media Nodes**

    8. **Start all the Master Nodes and all the Media Nodes**

        ```bash
        sudo systemctl start openvidu
        ```

=== "Changing `MONGO_ADMIN_USERNAME` and `MONGO_ADMIN_PASSWORD`"

    To change the `MONGO_ADMIN_USERNAME` and `MONGO_ADMIN_PASSWORD` parameters, follow these steps:

    1. **Stop OpenVidu in all the Master Nodes and all the Media Nodes and backup the deployment**

        ```bash
        sudo systemctl stop openvidu
        sudo cp -r /opt/openvidu/ /opt/openvidu_backup/
        ```

    2. **Replace in all the Master Nodes the `MONGO_ADMIN_USERNAME` and `MONGO_ADMIN_PASSWORD` in the `.env` file with your new values**

        !!!warning
            Keep the previous values of `MONGO_ADMIN_USERNAME` and `MONGO_ADMIN_PASSWORD` as you will need them to update the configuration files in the Media Nodes. We will refer to these values as `<CURRENT_MONGO_ADMIN_USERNAME>` and `<CURRENT_MONGO_ADMIN_PASSWORD>`.

    3. **Ensure to replace the `MONGO_ADMIN_USERNAME` and `MONGO_ADMIN_PASSWORD` in the `.env` file of all your Master Nodes**

    4. **Find the current locations of `MONGO_ADMIN_USERNAME` and `MONGO_ADMIN_PASSWORD` in your Media Nodes**

        With the `CURRENT_MONGO_ADMIN_USERNAME` and `CURRENT_MONGO_ADMIN_PASSWORD` values obtained in step 2, you can find all occurrences of the current MongoDB admin username and password in the configuration files of the Media Nodes. To do this, connect to each Media Node and run the following command:

        ```bash
        sudo su
        cd /opt/openvidu/
        CURRENT_MONGO_ADMIN_USERNAME="<CURRENT_MONGO_ADMIN_USERNAME>"
        CURRENT_MONGO_ADMIN_PASSWORD="<CURRENT_MONGO_ADMIN_PASSWORD>"
        grep --exclude-dir=data -IHnr "$CURRENT_MONGO_ADMIN_USERNAME" .
        grep --exclude-dir=data -IHnr "$CURRENT_MONGO_ADMIN_PASSWORD" .
        ```

        === "Example output"

            The output should look similar to the following for `MONGO_ADMIN_USERNAME`:

            ```bash
            ./config/livekit.yaml:mongo_url: <MONGO_URL>
            ```

            And for `MONGO_ADMIN_PASSWORD`:

            ```bash
            ./config/livekit.yaml:mongo_url: <MONGO_URL>
            ```

    5. **Update the Following Files in your Media Nodes**

        Based on the output from the previous step, update the following files with the new values:

        - `config/livekit.yaml`

    6. **Verify the changes in your Media Nodes**

        These commands will list all occurrences of the new `MONGO_ADMIN_USERNAME` and `MONGO_ADMIN_PASSWORD` in the configuration files of the Media Nodes. The output should match the locations found in the initial search but with the new values.

        ```bash
        sudo su
        cd /opt/openvidu/
        NEW_MONGO_ADMIN_USERNAME="<NEW_MONGO_ADMIN_USERNAME>"
        NEW_MONGO_ADMIN_PASSWORD="<NEW_MONGO_ADMIN_PASSWORD>"
        grep --exclude-dir=data -IHnr "$NEW_MONGO_ADMIN_USERNAME" .
        grep --exclude-dir=data -IHnr "$NEW_MONGO_ADMIN_PASSWORD" .
        ```

    7. **Ensure to follow from step 3 to 5 for all your Media Nodes**

    8. **Start all the Master Nodes and all the Media Nodes**

        ```bash
        sudo systemctl start openvidu
        ```

--8<-- "docs/docs/self-hosting/shared/openvidu-pro-uninstall.md"
